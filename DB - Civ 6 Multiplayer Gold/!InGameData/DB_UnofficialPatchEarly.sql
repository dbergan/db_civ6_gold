-- Units no longer become arbitrarily obsolete
UPDATE Units SET MandatoryObsoleteTech = NULL ;


-- Fascism War Weariness
UPDATE ModifierArguments SET Value = CASE WHEN Value > 0 THEN Value * -1 ELSE Value END WHERE ModifierId = 'FASCISM_WAR_WEARINESS' AND Name = 'Amount' ;



-- Siege promotions: Shrapnel, Grape Shot, and Shells should only apply to attacks. (Advanced Rangefinding already only applies to attacks.)
INSERT OR IGNORE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('SHRAPNEL_REQUIREMENTS', 'PLAYER_IS_ATTACKER_REQUIREMENTS') ;
INSERT OR IGNORE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('GRAPE_SHOT_REQUIREMENTS', 'PLAYER_IS_ATTACKER_REQUIREMENTS') ;
INSERT OR IGNORE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('SHELLS_REQUIREMENTS', 'PLAYER_IS_ATTACKER_REQUIREMENTS') ;


-- Land ranged promotion: Arrow Storm should not work against cities/encampments
INSERT OR IGNORE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('ARROW_STORM_REQUIREMENTS', 'DB_REQ_OPPONENT_IS_NOT_CITY_OR_ENCAMPMENT') ;

-- Land ranged promotion: Emplacement is bugged with this requirement (still has OPPONENT_IS_DISTRICT and PLAYER_IS_DEFENDER_REQUIREMENTS)
DELETE FROM RequirementSetRequirements WHERE RequirementSetId = 'EMPLACEMENT_REQUIREMENTS' AND RequirementId = 'OPPONENT_PLOT_IS_CITY_CENTER_REQUIREMENT' ;

-- Fix Information Age great admiral sea movement
UPDATE ModifierArguments SET Name = 'AbilityType' WHERE ModifierId = 'GREATPERSON_MOVEMENT_AOE_INFORMATION_SEA' AND Name = 'ModifierId' ;

-- Fix Barding combat preview
UPDATE ModifierStrings SET Text = '+{1_AMOUNT} {LOC_PROMOTION_BARDING_NAME} {LOC_PROMOTION_DESCRIPTOR_PREVIEW_TEXT}' WHERE ModifierId = 'TOP_COVER_DEFENSE_BONUS_VS_RANGED' AND Context = 'Preview' ;

-- Fix Interceptor combat preview
UPDATE ModifierStrings SET Text = '+{1_AMOUNT} {LOC_PROMOTION_INTERCEPTOR_NAME} {LOC_PROMOTION_DESCRIPTOR_PREVIEW_TEXT}' WHERE ModifierId = 'INTERCEPTOR_BONUS_VS_BOMBERS' AND Context = 'Preview' ;

-- Fix Water Mill - resources need to have a farm
INSERT OR IGNORE INTO RequirementSetRequirements (RequirementSetId, RequirementId) 
SELECT REPLACE(ResourceType, 'RESOURCE', 'RESOURCE_IS'), 'REQUIRES_PLOT_HAS_FARM'  FROM Improvement_ValidResources WHERE ImprovementType = 'IMPROVEMENT_FARM' ;

-- Fix Drone ignoring terrain costs
INSERT OR REPLACE INTO TypeTags (Type, Tag) SELECT 'ABILITY_IGNORE_TERRAIN_COST', 'CLASS_DRONE' WHERE EXISTS (SELECT * FROM Tags WHERE Tag = 'CLASS_DRONE') ;
INSERT OR REPLACE INTO TypeTags (Type, Tag) SELECT 'ABILITY_IGNORE_CROSSING_RIVERS_COST', 'CLASS_DRONE' WHERE EXISTS (SELECT * FROM Tags WHERE Tag = 'CLASS_DRONE') ;

-- Great Generals enhance units from any earlier era
UPDATE RequirementSetRequirements SET RequirementId = 'DB_REQ_UNIT_IS_MEDIEVAL_OR_EARLIER'		WHERE RequirementId = 'AOE_REQUIRES_CLASSICAL_REQUIREMENTS' ;
UPDATE RequirementSetRequirements SET RequirementId = 'DB_REQ_UNIT_IS_RENAISSANCE_OR_EARLIER'	WHERE RequirementId = 'AOE_REQUIRES_MEDIEVAL_REQUIREMENTS' ;
UPDATE RequirementSetRequirements SET RequirementId = 'DB_REQ_UNIT_IS_INDUSTRIAL_OR_EARLIER'	WHERE RequirementId = 'AOE_REQUIRES_RENAISSANCE_REQUIREMENTS' ;
UPDATE RequirementSetRequirements SET RequirementId = 'DB_REQ_UNIT_IS_MODERN_OR_EARLIER'		WHERE RequirementId = 'AOE_REQUIRES_INDUSTRIAL_REQUIREMENTS' ;
UPDATE RequirementSetRequirements SET RequirementId = 'DB_REQ_UNIT_IS_ATOMIC_OR_EARLIER'		WHERE RequirementId = 'AOE_REQUIRES_MODERN_REQUIREMENTS' ;
UPDATE RequirementSetRequirements SET RequirementId = 'DB_REQ_UNIT_IS_INFORMATION_OR_EARLIER'	WHERE RequirementId = 'AOE_REQUIRES_ATOMIC_REQUIREMENTS' ;
UPDATE RequirementSetRequirements SET RequirementId = (SELECT CASE WHEN EXISTS (SELECT RequirementId FROM Requirements WHERE RequirementID = 'DB_REQ_UNIT_IS_FUTURE_OR_EARLIER') THEN 'DB_REQ_UNIT_IS_FUTURE_OR_EARLIER' ELSE 'DB_REQ_UNIT_IS_INFORMATION_OR_EARLIER' END) WHERE RequirementId = 'AOE_REQUIRES_INFORMATION_REQUIREMENTS' ;
-- UPDATE RequirementSetRequirements SET RequirementId = 'DB_REQ_UNIT_IS_FUTURE_OR_EARLIER'		WHERE RequirementId = 'AOE_REQUIRES_INFORMATION_REQUIREMENTS' ;

-- Embarked units don't heal
INSERT OR IGNORE INTO GameModifiers (ModifierId) VALUES ('DB_MOD_EMBARKED_UNITS_DONT_HEAL_UNITS_ATTACH_MODIFIER') ;
INSERT OR IGNORE INTO Modifiers (ModifierId, ModifierType, SubjectRequirementSetId) VALUES ('DB_MOD_EMBARKED_UNITS_DONT_HEAL_UNITS_ATTACH_MODIFIER', 'MODIFIER_ALL_UNITS_ATTACH_MODIFIER', 'DB_REQSET_EMBARKED') ;
INSERT OR IGNORE INTO ModifierArguments (ModifierId, Name, Value) VALUES ('DB_MOD_EMBARKED_UNITS_DONT_HEAL_UNITS_ATTACH_MODIFIER', 'ModifierId', 'DB_MOD_DOESNT_HEAL') ;

-- Embarked units negate the -17 penalty that siege units have hitting them
INSERT OR IGNORE INTO RequirementSets (RequirementSetId, RequirementSetType) VALUES ('DB_REQSET_VS_SIEGE_UNIT', 'REQUIREMENTSET_TEST_ALL') ;
INSERT OR IGNORE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('DB_REQSET_VS_SIEGE_UNIT', 'OPPONENT_SIEGE_REQUIREMENT') ;

INSERT OR IGNORE INTO GameModifiers (ModifierId) VALUES ('DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_UNITS_ATTACH_MODIFIER') ;
INSERT OR IGNORE INTO Modifiers (ModifierId, ModifierType, SubjectRequirementSetId) VALUES ('DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_UNITS_ATTACH_MODIFIER', 'MODIFIER_ALL_UNITS_ATTACH_MODIFIER', 'DB_REQSET_EMBARKED') ;
INSERT OR IGNORE INTO ModifierArguments (ModifierId, Name, Value) VALUES ('DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_UNITS_ATTACH_MODIFIER', 'ModifierId', 'DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_COMBAT') ;
INSERT OR IGNORE INTO Modifiers (ModifierId, ModifierType, SubjectRequirementSetId) VALUES ('DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_COMBAT', 'MODIFIER_UNIT_ADJUST_COMBAT_STRENGTH', 'DB_REQSET_VS_SIEGE_UNIT') ;
INSERT OR IGNORE INTO ModifierArguments (ModifierId, Name, Value) VALUES ('DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_COMBAT', 'Amount', -17) ;
INSERT OR IGNORE INTO ModifierStrings (ModifierId, Context, Text) VALUES ('DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_COMBAT', 'Preview', 'LOC_PREVIEW_DB_MOD_EMBARKED_VULNERABLE_TO_SIEGE_COMBAT') ;

-- Fix Meenakshi temple
DELETE FROM BuildingModifiers WHERE ModifierId = 'MEENAKSHITEMPLE_RELIGIOUS_UNITS_COMBAT' OR ModifierId = 'MEENAKSHITEMPLE_RELIGIOUS_UNITS_MOVEMENT' ;
DELETE FROM Modifiers WHERE ModifierId = 'MEENAKSHITEMPLE_RELIGIOUS_UNITS_COMBAT' OR ModifierId = 'MEENAKSHITEMPLE_RELIGIOUS_UNITS_MOVEMENT' ;
DELETE FROM ModifierArguments WHERE ModifierId = 'MEENAKSHITEMPLE_RELIGIOUS_UNITS_COMBAT' OR ModifierId = 'MEENAKSHITEMPLE_RELIGIOUS_UNITS_MOVEMENT' ;
DELETE FROM Types WHERE Type = 'ABILITY_SAGE_COMBAT_AOE_RELIGIOUS' OR Type = 'ABILITY_GUIDE_MOVEMENT_AOE_RELIGIOUS' ;
DELETE FROM TypeTags WHERE Type = 'ABILITY_SAGE_COMBAT_AOE_RELIGIOUS' OR Type = 'ABILITY_GUIDE_MOVEMENT_AOE_RELIGIOUS' ;
DELETE FROM UnitAbilities WHERE UnitAbilityType = 'ABILITY_SAGE_COMBAT_AOE_RELIGIOUS' OR UnitAbilityType = 'ABILITY_GUIDE_MOVEMENT_AOE_RELIGIOUS' ;
DELETE FROM UnitAbilityModifiers WHERE UnitAbilityType = 'ABILITY_SAGE_COMBAT_AOE_RELIGIOUS' OR UnitAbilityType = 'ABILITY_GUIDE_MOVEMENT_AOE_RELIGIOUS' ; -- SAGE_COMBAT_AOE_RELIGIOUS_XP2, GUIDE_MOVEMENT_AOE_RELIGIOUS_XP2
DELETE FROM Modifiers WHERE ModifierId = 'SAGE_COMBAT_AOE_RELIGIOUS_XP2' OR ModifierId = 'GUIDE_MOVEMENT_AOE_RELIGIOUS_XP2' ; -- MODIFIER_PLAYER_UNITS_GRANT_ABILITY
DELETE FROM ModifierArguments WHERE ModifierId = 'SAGE_COMBAT_AOE_RELIGIOUS_XP2' OR ModifierId = 'GUIDE_MOVEMENT_AOE_RELIGIOUS_XP2' ; -- ABILITY_GURU_STRENGTH, ABILITY_GURU_MOVEMENT

DELETE FROM Types WHERE Type = 'ABILITY_GURU_STRENGTH' OR Type = 'ABILITY_GURU_MOVEMENT' ;
DELETE FROM TypeTags WHERE Type = 'ABILITY_GURU_STRENGTH' OR Type = 'ABILITY_GURU_MOVEMENT' ; -- CLASS_RELIGIOUS_ALL
DELETE FROM UnitAbilities WHERE UnitAbilityType = 'ABILITY_GURU_STRENGTH' OR UnitAbilityType = 'ABILITY_GURU_MOVEMENT' ;
DELETE FROM UnitAbilityModifiers WHERE UnitAbilityType = 'ABILITY_GURU_STRENGTH' OR UnitAbilityType = 'ABILITY_GURU_MOVEMENT' ; -- GURU_STRENGTH_XP2, GURU_MOVEMENT_XP2
DELETE FROM Modifiers WHERE ModifierId = 'GURU_STRENGTH_XP2' OR ModifierId = 'GURU_MOVEMENT_XP2' ; -- AOE_GURU_REQUIREMENTS_XP2
DELETE FROM ModifierArguments WHERE ModifierId = 'GURU_STRENGTH_XP2' OR ModifierId = 'GURU_MOVEMENT_XP2' ;

INSERT OR REPLACE INTO Requirements (RequirementId, RequirementType) VALUES ('DB_REQ_UNIT_IS_GURU', 'REQUIREMENT_UNIT_TYPE_MATCHES') ;
INSERT OR REPLACE INTO RequirementArguments (RequirementId, Name, Value) VALUES ('DB_REQ_UNIT_IS_GURU', 'UnitType', 'UNIT_GURU') ;
INSERT OR REPLACE INTO RequirementSets (RequirementSetId, RequirementSetType) VALUES ('DB_REQSET_UNIT_IS_GURU', 'REQUIREMENTSET_TEST_ALL') ;
INSERT OR REPLACE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('DB_REQSET_UNIT_IS_GURU', 'DB_REQ_UNIT_IS_GURU') ;

INSERT OR REPLACE INTO RequirementSets (RequirementSetId, RequirementSetType) VALUES ('DB_REQSET_UNIT_IS_RELIGIOUS_ALL', 'REQUIREMENTSET_TEST_ALL') ;
INSERT OR REPLACE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('DB_REQSET_UNIT_IS_RELIGIOUS_ALL', 'REQUIRES_UNIT_IS_RELIGIOUS_ALL') ;

INSERT OR REPLACE INTO Requirements (RequirementId, RequirementType) VALUES ('DB_REQ_NEXTTO_GURU', 'REQUIREMENT_PLOT_ADJACENT_FRIENDLY_UNIT_TYPE_MATCHES') ;
INSERT OR REPLACE INTO RequirementArguments (RequirementId, Name, Value) VALUES ('DB_REQ_NEXTTO_GURU', 'UnitType', 'UNIT_GURU') ;
INSERT OR REPLACE INTO RequirementSets (RequirementSetId, RequirementSetType) VALUES ('DB_REQSET_NEXTTO_GURU', 'REQUIREMENTSET_TEST_ALL') ;
INSERT OR REPLACE INTO RequirementSetRequirements (RequirementSetId, RequirementId) VALUES ('DB_REQSET_NEXTTO_GURU', 'DB_REQ_NEXTTO_GURU') ;


-- Meenakshi combat
INSERT OR REPLACE INTO BuildingModifiers (BuildingType, ModifierId)
	SELECT BuildingType, 'DB_MEENAKSHITEMPLE_GURU_ENHANCES_COMBAT' FROM Buildings WHERE BuildingType IN ('BUILDING_MEENAKSHI_TEMPLE') ;
INSERT OR REPLACE INTO Modifiers (ModifierId, ModifierType, Permanent, SubjectRequirementSetId) VALUES 
                      ('DB_MEENAKSHITEMPLE_GURU_ENHANCES_COMBAT', 'MODIFIER_PLAYER_UNITS_GRANT_ABILITY', 0, 'DB_REQSET_UNIT_IS_RELIGIOUS_ALL') ;
INSERT OR REPLACE INTO ModifierArguments (ModifierId, Name, Value) VALUES 
                      ('DB_MEENAKSHITEMPLE_GURU_ENHANCES_COMBAT', 'AbilityType', 'DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU') ;

INSERT OR REPLACE INTO Types (Type, Kind) VALUES ('DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU', 'KIND_ABILITY') ;
INSERT OR REPLACE INTO TypeTags (Type, Tag) VALUES ('DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU', 'CLASS_RELIGIOUS_ALL') ;
INSERT OR REPLACE INTO UnitAbilities (UnitAbilityType, Inactive, Name, Description) VALUES ('DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU', 1, 'LOC_DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU_NAME', 'LOC_DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU_DESC') ;
INSERT OR REPLACE INTO UnitAbilityModifiers (UnitAbilityType, ModifierId) VALUES ('DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU', 'DB_ENHANCE_COMBAT_WHEN_ADJ_GURU') ;

INSERT OR REPLACE INTO Modifiers (ModifierId, ModifierType, SubjectRequirementSetId) VALUES ('DB_ENHANCE_COMBAT_WHEN_ADJ_GURU', 'MODIFIER_UNIT_ADJUST_COMBAT_STRENGTH', 'DB_REQSET_NEXTTO_GURU') ;
INSERT OR REPLACE INTO ModifierArguments (ModifierId, Name, Value) VALUES ('DB_ENHANCE_COMBAT_WHEN_ADJ_GURU', 'Amount', 5) ;
INSERT OR REPLACE INTO ModifierStrings (ModifierId, Context, Text) VALUES ('DB_ENHANCE_COMBAT_WHEN_ADJ_GURU', 'Preview', 'LOC_DB_ABILITY_ENHANCE_COMBAT_WHEN_ADJ_GURU_COMBAT_DESC') ;


-- Meenakshi Movement
INSERT OR REPLACE INTO BuildingModifiers (BuildingType, ModifierId)
	SELECT BuildingType, 'DB_MEENAKSHITEMPLE_GURU_ENHANCES_MOVEMENT' FROM Buildings WHERE BuildingType IN ('BUILDING_MEENAKSHI_TEMPLE') ;
INSERT OR REPLACE INTO Modifiers (ModifierId, ModifierType, Permanent, SubjectRequirementSetId) VALUES 
                      ('DB_MEENAKSHITEMPLE_GURU_ENHANCES_MOVEMENT', 'MODIFIER_PLAYER_UNITS_GRANT_ABILITY', 0, 'DB_REQSET_UNIT_IS_RELIGIOUS_ALL') ;
INSERT OR REPLACE INTO ModifierArguments (ModifierId, Name, Value) VALUES 
                      ('DB_MEENAKSHITEMPLE_GURU_ENHANCES_MOVEMENT', 'AbilityType', 'DB_ABILITY_ENHANCE_MOVEMENT_WHEN_ADJ_GURU') ;

INSERT OR REPLACE INTO Types (Type, Kind) VALUES ('DB_ABILITY_ENHANCE_MOVEMENT_WHEN_ADJ_GURU', 'KIND_ABILITY') ;
INSERT OR REPLACE INTO TypeTags (Type, Tag) VALUES ('DB_ABILITY_ENHANCE_MOVEMENT_WHEN_ADJ_GURU', 'CLASS_RELIGIOUS_ALL') ;
INSERT OR REPLACE INTO UnitAbilities (UnitAbilityType, Inactive, Name, Description) VALUES ('DB_ABILITY_ENHANCE_MOVEMENT_WHEN_ADJ_GURU', 1, 'LOC_DB_ABILITY_ENHANCE_MOVEMENT_WHEN_ADJ_GURU_NAME', 'LOC_DB_ABILITY_ENHANCE_MOVEMENT_WHEN_ADJ_GURU_DESC') ;
INSERT OR REPLACE INTO UnitAbilityModifiers (UnitAbilityType, ModifierId) VALUES ('DB_ABILITY_ENHANCE_MOVEMENT_WHEN_ADJ_GURU', 'DB_ENHANCE_MOVEMENT_WHEN_ADJ_GURU') ;

INSERT OR REPLACE INTO Modifiers (ModifierId, ModifierType, SubjectRequirementSetId) VALUES ('DB_ENHANCE_MOVEMENT_WHEN_ADJ_GURU', 'MODIFIER_PLAYER_UNIT_ADJUST_MOVEMENT', 'DB_REQSET_NEXTTO_GURU') ;
INSERT OR REPLACE INTO ModifierArguments (ModifierId, Name, Value) VALUES ('DB_ENHANCE_MOVEMENT_WHEN_ADJ_GURU', 'Amount', 1) ;